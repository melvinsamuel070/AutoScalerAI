# name: AutoScaler.AI CI/CD

# on:
#   push:
#     branches:
#       - master

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest

#     steps:
#     # -------------------------
#     # Checkout code
#     - name: Checkout code
#       uses: actions/checkout@v3

#     # -------------------------
#     # Set up Docker Buildx
#     - name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v2

#     # -------------------------
#     # Log in to Docker Hub
#     - name: Log in to Docker Hub
#       uses: docker/login-action@v2
#       with:
#         username: ${{ secrets.DOCKER_USERNAME }}
#         password: ${{ secrets.DOCKER_PASSWORD }}

#     # -------------------------
#     # Build & Push Backend with cache
#     - name: Build & Push Backend
#       uses: docker/build-push-action@v5
#       with:
#         context: ./backend
#         file: ./backend/Dockerfile
#         push: true
#         tags: melvinsamuel070/backend:latest
#         cache-from: type=registry,ref=melvinsamuel070/backend:latest
#         cache-to: type=registry,ref=melvinsamuel070/backend:cache,mode=max

#     # -------------------------
#     # Build & Push Frontend with cache
#     - name: Build & Push Frontend
#       uses: docker/build-push-action@v5
#       with:
#         context: ./frontend
#         file: ./frontend/Dockerfile
#         push: true
#         tags: melvinsamuel070/frontend:latest
#         cache-from: type=registry,ref=melvinsamuel070/frontend:latest
#         cache-to: type=registry,ref=melvinsamuel070/frontend:cache,mode=max

#     # -------------------------
#     # Install Minikube
#     - name: Install Minikube
#       run: |
#         echo "Installing Minikube..."
#         curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
#         chmod +x minikube
#         sudo mv minikube /usr/local/bin/
#         minikube version

#     # -------------------------
#     # Start Minikube if not running
#     - name: Start Minikube
#       run: |
#         echo "Checking Minikube status..."
#         if ! minikube status | grep -q "host: Running"; then
#           echo "üöÄ Starting Minikube..."
#           minikube start --driver=docker --wait=all
#         else
#           echo "‚úÖ Minikube already running."
#         fi
#         echo "Verifying Minikube readiness..."
#         minikube status

#     # -------------------------
#     # Configure Docker to use Minikube
#     - name: Use Minikube Docker daemon
#       run: |
#         echo "Configuring Docker to use Minikube's Docker daemon..."
#         eval $(minikube -p minikube docker-env)

#     # -------------------------
#     # Load images into Minikube
#     - name: Load Docker images into Minikube
#       run: |
#         echo "Loading backend image..."
#         minikube image load melvinsamuel070/backend:latest
#         echo "Loading frontend image..."
#         minikube image load melvinsamuel070/frontend:latest

#     # -------------------------
#     # Install kubectl
#     - name: Install kubectl
#       run: |
#         echo "Installing kubectl..."
#         sudo curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
#         sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
#         kubectl version --client

#     # -------------------------
#     # Set kubectl context to Minikube
#     - name: Configure kubectl context
#       run: |
#         echo "Setting kubectl context to Minikube..."
#         kubectl config use-context minikube
#         kubectl cluster-info

#     # -------------------------
#     # Deploy to Minikube
#     - name: Deploy to Minikube
#       run: |
#         echo "Applying Kubernetes manifests (skipping schema validation)..."
#         kubectl apply -f k8s/ --validate=false

#         echo "Restarting deployments to pick latest images..."
#         kubectl rollout restart deployment backend
#         kubectl rollout restart deployment frontend

#         echo "Waiting for deployments to be ready..."
#         kubectl rollout status deployment backend
#         kubectl rollout status deployment frontend

#         echo "Listing pods and services..."
#         kubectl get pods -o wide
#         kubectl get svc -o wide


































name: AutoScaler.AI CI/CD

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # -------------------------
    # Checkout code
    - name: Checkout code
      uses: actions/checkout@v3

    # -------------------------
    # Install Minikube
    - name: Install Minikube
      run: |
        curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        chmod +x minikube
        sudo mv minikube /usr/local/bin/
        minikube version

    # -------------------------
    # Start Minikube (with cache check)
    - name: Start Minikube
      run: |
        echo "üîç Checking Minikube status..."
        if ! minikube status | grep -q "host: Running"; then
          echo "üöÄ Starting Minikube..."
          minikube start --driver=docker --wait=all --memory=4096 --cpus=2
        else
          echo "‚úÖ Minikube already running."
        fi
        minikube status

    # -------------------------
    # Use Minikube Docker daemon
    - name: Use Minikube Docker
      run: |
        echo "üîß Setting up Docker to use Minikube‚Äôs environment..."
        eval $(minikube -p minikube docker-env)
        docker info

    # -------------------------
    # Build Docker images directly into Minikube
    - name: Build Backend Image
      run: |
        echo "üõ†Ô∏è Building backend image..."
        eval $(minikube -p minikube docker-env)
        docker build -t backend:latest ./backend

    - name: Build Frontend Image
      run: |
        echo "üõ†Ô∏è Building frontend image..."
        eval $(minikube -p minikube docker-env)
        docker build -t frontend:latest ./frontend

    # -------------------------
    # Install kubectl
    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        kubectl version --client

    # -------------------------
    # Configure kubectl context
    - name: Configure kubectl context
      run: |
        kubectl config use-context minikube
        echo "‚úÖ Using context: $(kubectl config current-context)"

    # -------------------------
    # Deploy to Minikube
    - name: Deploy to Minikube
      run: |
        echo "üöÄ Applying Kubernetes manifests..."
        kubectl apply -f k8s/ --validate=false

        echo "üîÅ Restarting deployments..."
        kubectl rollout restart deployment backend
        kubectl rollout restart deployment frontend

        echo "‚è≥ Waiting for backend rollout..."
        if ! kubectl rollout status deployment backend --timeout=180s; then
          echo "‚ö†Ô∏è Backend rollout failed, printing debug info..."
          kubectl describe deployment backend
          kubectl get pods -l app=backend -o wide
          kubectl logs -l app=backend --tail=50 || true
        fi

        echo "‚è≥ Waiting for frontend rollout..."
        if ! kubectl rollout status deployment frontend --timeout=180s; then
          echo "‚ö†Ô∏è Frontend rollout failed, printing debug info..."
          kubectl describe deployment frontend
          kubectl get pods -l app=frontend -o wide
          kubectl logs -l app=frontend --tail=50 || true
        fi

        echo "‚úÖ Deployments applied successfully."
        kubectl get pods -o wide
        kubectl get svc -o wide

    # -------------------------
    # Get Minikube Service URL for browser testing
    - name: Get Frontend URL
      run: |
        echo "üåê Fetching frontend URL..."
        FRONTEND_URL=$(minikube service frontend-service --url)
        echo "‚úÖ Frontend available at: $FRONTEND_URL"
        echo "You can open this URL in your browser for testing."
