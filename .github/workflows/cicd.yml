name: AutoScaler.AI CI/CD

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # -------------------------
    # Checkout code
    - name: Checkout code
      uses: actions/checkout@v3

    # -------------------------
    # Set up Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # -------------------------
    # Log in to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # -------------------------
    # Build & Push Backend with cache
    - name: Build & Push Backend
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: melvinsamuel070/backend:latest
        cache-from: type=registry,ref=melvinsamuel070/backend:latest
        cache-to: type=registry,ref=melvinsamuel070/backend:cache,mode=max

    # -------------------------
    # Build & Push Frontend with cache
    - name: Build & Push Frontend
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: melvinsamuel070/frontend:latest
        cache-from: type=registry,ref=melvinsamuel070/frontend:latest
        cache-to: type=registry,ref=melvinsamuel070/frontend:cache,mode=max

    # -------------------------
    # Set up Kind (Kubernetes-in-Docker)
    - name: Set up Kind
      uses: engineerd/setup-kind@v0.5.0
      with:
        version: v0.20.0

    # -------------------------
    # Load Docker images into Kind cluster
    - name: Load Docker images into Kind
      run: |
        kind load docker-image melvinsamuel070/backend:latest
        kind load docker-image melvinsamuel070/frontend:latest

    # -------------------------
    # Set up kubectl
    - name: Install kubectl
      run: |
        sudo curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        kubectl version --client

    # -------------------------
    # Apply Kubernetes manifests & restart deployments
    - name: Deploy to Kubernetes
      env:
        KUBECONFIG: ${{ secrets.KUBECONFIG }}
      run: |
        echo "Applying Kubernetes manifests (skipping schema validation)..."
        kubectl apply -f k8s/ --validate=false

        echo "Restarting deployments to pick latest images..."
        kubectl rollout restart deployment backend
        kubectl rollout restart deployment frontend

        echo "Waiting for deployments to be ready..."
        kubectl rollout status deployment backend
        kubectl rollout status deployment frontend

        echo "Listing pods and services..."
        kubectl get pods -o wide
        kubectl get svc -o wide
